<!doctype html>



  


<html class="theme-next pisces use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="android," />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta name="description" content="我们在设计项目的时候，经常会遇到一些奇奇怪怪的需求，在这些需求中，对于UI的需求更是占了大半部分，这时候我们就避免不了与View打交道，熟悉自定义View的旁友应该会将onMeasure()-&amp;gt;onLayout-&amp;gt;onDraw的调用过程烂熟于心。因此，为了在撸代码的时候更加的对VIew得心应手，我们有必要对其进行一个深入的了解，下面就从构造方法看起吧。">
<meta property="og:type" content="article">
<meta property="og:title" content="android View的探索(二) : View的形成过程">
<meta property="og:url" content="http://yoursite.com/2016/12/09/android-View的探索-二-View的形成过程/index.html">
<meta property="og:site_name" content="Jerry Chan">
<meta property="og:description" content="我们在设计项目的时候，经常会遇到一些奇奇怪怪的需求，在这些需求中，对于UI的需求更是占了大半部分，这时候我们就避免不了与View打交道，熟悉自定义View的旁友应该会将onMeasure()-&amp;gt;onLayout-&amp;gt;onDraw的调用过程烂熟于心。因此，为了在撸代码的时候更加的对VIew得心应手，我们有必要对其进行一个深入的了解，下面就从构造方法看起吧。">
<meta property="og:image" content="http://yoursite.com/2016/12/09/android-View的探索-二-View的形成过程/one.png">
<meta property="og:image" content="http://yoursite.com/2016/12/09/android-View的探索-二-View的形成过程/two.jpg">
<meta property="og:updated_time" content="2016-12-13T02:41:59.000Z">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="android View的探索(二) : View的形成过程">
<meta name="twitter:description" content="我们在设计项目的时候，经常会遇到一些奇奇怪怪的需求，在这些需求中，对于UI的需求更是占了大半部分，这时候我们就避免不了与View打交道，熟悉自定义View的旁友应该会将onMeasure()-&amp;gt;onLayout-&amp;gt;onDraw的调用过程烂熟于心。因此，为了在撸代码的时候更加的对VIew得心应手，我们有必要对其进行一个深入的了解，下面就从构造方法看起吧。">
<meta name="twitter:image" content="http://yoursite.com/2016/12/09/android-View的探索-二-View的形成过程/one.png">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://yoursite.com/2016/12/09/android-View的探索-二-View的形成过程/"/>





  <title> android View的探索(二) : View的形成过程 | Jerry Chan </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  










  
  
    
  

  <div class="container one-collumn sidebar-position-left page-post-detail ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Jerry Chan</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">Android Developer</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            

  <div id="posts" class="posts-expand">
    

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
  <link itemprop="mainEntityOfPage" href="http://yoursite.com/2016/12/09/android-View的探索-二-View的形成过程/">

  <span style="display:none" itemprop="author" itemscope itemtype="http://schema.org/Person">
    <meta itemprop="name" content="Jerry Chan">
    <meta itemprop="description" content="">
    <meta itemprop="image" content="/images/avatar.jpg">
  </span>

  <span style="display:none" itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
    <meta itemprop="name" content="Jerry Chan">
    <span style="display:none" itemprop="logo" itemscope itemtype="http://schema.org/ImageObject">
      <img style="display:none;" itemprop="url image" alt="Jerry Chan" src="">
    </span>
  </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                android View的探索(二) : View的形成过程
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">发表于</span>
              <time title="Post created" itemprop="dateCreated datePublished" datetime="2016-12-09T16:35:46+08:00">
                2016-12-09
              </time>
            

            

            
          </span>

          
            <span class="post-category" >
              <span class="post-meta-divider">|</span>
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="http://schema.org/Thing">
                  <a href="/categories/Android源码研究/" itemprop="url" rel="index">
                    <span itemprop="name">Android源码研究</span>
                  </a>
                </span>

                
                
              
            </span>
          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <a href="/2016/12/09/android-View的探索-二-View的形成过程/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/12/09/android-View的探索-二-View的形成过程/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/12/09/android-View的探索-二-View的形成过程/" class="leancloud_visitors" data-flag-title="android View的探索(二) : View的形成过程">
               <span class="post-meta-divider">|</span>
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        <p>我们在设计项目的时候，经常会遇到一些奇奇怪怪的需求，在这些需求中，对于UI的需求更是占了大半部分，这时候我们就避免不了与View打交道，熟悉自定义View的旁友应该会将onMeasure()-&gt;onLayout-&gt;onDraw的调用过程烂熟于心。因此，为了在撸代码的时候更加的对VIew得心应手，我们有必要对其进行一个深入的了解，下面就从构造方法看起吧。<br><a id="more"></a></p>
<p>View的构造方法如下：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">public</span> <span class="title">View</span><span class="params">(Context context)</span> </span>&#123;</div><div class="line"></div><div class="line">       mContext = context;</div><div class="line">       mResources = context != <span class="keyword">null</span> ? context.getResources() : <span class="keyword">null</span>;</div><div class="line">       mViewFlags = SOUND_EFFECTS_ENABLED | HAPTIC_FEEDBACK_ENABLED;</div><div class="line">       ....</div><div class="line"></div><div class="line">           sCompatibilityDone = <span class="keyword">true</span>;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">​</div><div class="line"> <span class="function"><span class="keyword">public</span> <span class="title">View</span><span class="params">(Context context, @Nullable AttributeSet attrs, <span class="keyword">int</span> defStyleAttr, <span class="keyword">int</span> defStyleRes)</span> </span>&#123;</div><div class="line">       <span class="keyword">this</span>(context);</div><div class="line">​</div><div class="line">       <span class="keyword">final</span> TypedArray a = context.obtainStyledAttributes(</div><div class="line">               attrs, com.android.internal.R.styleable.View, defStyleAttr, defStyleRes);</div><div class="line">​</div><div class="line">       <span class="keyword">if</span> (mDebugViewAttributes) &#123;</div><div class="line">           saveAttributeData(attrs, a);</div><div class="line">       &#125;</div><div class="line">​</div><div class="line">       Drawable background = <span class="keyword">null</span>;</div><div class="line">​</div><div class="line">       ...</div><div class="line"></div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> N = a.getIndexCount();</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; N; i++) &#123;</div><div class="line">           <span class="keyword">int</span> attr = a.getIndex(i);</div><div class="line">           <span class="keyword">switch</span> (attr) &#123;</div><div class="line">               <span class="comment">//读取attr的参数</span></div><div class="line">               ...</div><div class="line">           &#125;</div><div class="line">  <span class="comment">//设置View的滚动模式</span></div><div class="line">       setOverScrollMode(overScrollMode);</div><div class="line">​</div><div class="line">       <span class="comment">// Cache start/end user padding as we cannot fully resolve padding here (we dont have yet</span></div><div class="line">       <span class="comment">// the resolved layout direction). Those cached values will be used later during padding</span></div><div class="line">       <span class="comment">// resolution.</span></div><div class="line">       mUserPaddingStart = startPadding;</div><div class="line">       mUserPaddingEnd = endPadding;</div><div class="line">  <span class="comment">//设置背景</span></div><div class="line">       <span class="keyword">if</span> (background != <span class="keyword">null</span>) &#123;</div><div class="line">           setBackground(background);</div><div class="line">       &#125;</div><div class="line">​</div><div class="line">       <span class="comment">// setBackground above will record that padding is currently provided by the background.</span></div><div class="line">       <span class="comment">// If we have padding specified via xml, record that here instead and use it.</span></div><div class="line">       mLeftPaddingDefined = leftPaddingDefined;</div><div class="line">       mRightPaddingDefined = rightPaddingDefined;</div><div class="line">​</div><div class="line">       ...</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>对于View的构造方法而言，在其中只是做了相关参数的初始化以及传入参数attr的数据的获取的操作，相对来说，并没有什么特别需要注意的地方，那我们直接查看到onMeasure中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"></div><div class="line">    * &lt;p&gt;</div><div class="line">    * Measure the view and its content to determine the measured width and the</div><div class="line">    * measured height. This method is invoked by &#123;<span class="doctag">@link</span> #measure(int, int)&#125; and</div><div class="line">    * should be overridden by subclasses to provide accurate and efficient</div><div class="line">    * measurement of their contents.</div><div class="line">    * &lt;/p&gt;</div><div class="line">    *</div><div class="line">    * &lt;p&gt;</div><div class="line">    * &lt;strong&gt;CONTRACT:&lt;/strong&gt; When overriding this method, you</div><div class="line">    * &lt;em&gt;must&lt;/em&gt; call &#123;<span class="doctag">@link</span> #setMeasuredDimension(int, int)&#125; to store the</div><div class="line">    * measured width and height of this view. Failure to do so will trigger an</div><div class="line">    * &lt;code&gt;IllegalStateException&lt;/code&gt;, thrown by</div><div class="line">    * &#123;<span class="doctag">@link</span> #measure(int, int)&#125;. Calling the superclass'</div><div class="line">    * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; is a valid use.</div><div class="line">    * &lt;/p&gt;</div><div class="line">    *</div><div class="line">    * &lt;p&gt;</div><div class="line">    * The base class implementation of measure defaults to the background size,</div><div class="line">    * unless a larger size is allowed by the MeasureSpec. Subclasses should</div><div class="line">    * override &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; to provide better measurements of</div><div class="line">    * their content.</div><div class="line">    * &lt;/p&gt;</div><div class="line">    *</div><div class="line">    * &lt;p&gt;</div><div class="line">    * If this method is overridden, it is the subclass's responsibility to make</div><div class="line">    * sure the measured height and width are at least the view's minimum height</div><div class="line">    * and width (&#123;<span class="doctag">@link</span> #getSuggestedMinimumHeight()&#125; and</div><div class="line">    * &#123;<span class="doctag">@link</span> #getSuggestedMinimumWidth()&#125;).</div><div class="line">    * &lt;/p&gt;</div><div class="line">    *</div><div class="line">  */</div><div class="line">    </div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">      setMeasuredDimension(getDefaultSize(getSuggestedMinimumWidth(), widthMeasureSpec),</div><div class="line">              getDefaultSize(getSuggestedMinimumHeight(), heightMeasureSpec));</div><div class="line">  &#125;</div></pre></td></tr></table></figure>
<p>在View注释中已经把onMeasure()解释得相当的完善了，我们可以在注释中获取一些信息：</p>
<ul>
<li><p>onMeasure()方法中会测量其本身View以及包含内容的宽高</p>
</li>
<li><p>当我们在子类中重写onMeasure()方法时，我们需要调用setMeasuredDimension(int, int)为这个View进行保存宽高</p>
</li>
<li><p>View默认的是background的大小</p>
</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line"></div><div class="line"><span class="comment">/**</span></div><div class="line"></div><div class="line">     * Utility to return a default size. Uses the supplied size if the</div><div class="line">     * MeasureSpec imposed no constraints. Will get larger if allowed</div><div class="line">     * by the MeasureSpec.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> size Default size for this view</div><div class="line">     * <span class="doctag">@param</span> measureSpec Constraints imposed by the parent</div><div class="line">     * <span class="doctag">@return</span> The size this view should be.</div><div class="line">     */</div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">int</span> <span class="title">getDefaultSize</span><span class="params">(<span class="keyword">int</span> size, <span class="keyword">int</span> measureSpec)</span> </span>&#123;</div><div class="line">       <span class="keyword">int</span> result = size;</div><div class="line">       <span class="keyword">int</span> specMode = MeasureSpec.getMode(measureSpec);</div><div class="line">       <span class="keyword">int</span> specSize = MeasureSpec.getSize(measureSpec);</div><div class="line">​</div><div class="line">       <span class="keyword">switch</span> (specMode) &#123;</div><div class="line">       <span class="keyword">case</span> MeasureSpec.UNSPECIFIED:</div><div class="line">           result = size;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       <span class="keyword">case</span> MeasureSpec.AT_MOST:</div><div class="line">       <span class="keyword">case</span> MeasureSpec.EXACTLY:</div><div class="line">           result = specSize;</div><div class="line">           <span class="keyword">break</span>;</div><div class="line">       &#125;</div><div class="line">       <span class="keyword">return</span> result;</div><div class="line">   &#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getSuggestedMinimumWidth</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> (mBackground == <span class="keyword">null</span>) ? mMinWidth : max(mMinWidth, mBackground.getMinimumWidth());</div><div class="line">   &#125;</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">int</span> <span class="title">getSuggestedMinimumHeight</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">return</span> (mBackground == <span class="keyword">null</span>) ? mMinHeight : max(mMinHeight, mBackground.getMinimumHeight());</div><div class="line">​</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>在上述代码中，我们可以看到在getDefaultSize()方法中通过MeasureSpec来获得测量模式和大小(MeasureSpec代表一个32位的int值，高两位代表了specMode，低30位specSize)。specMode总共有三种()</p>
<ul>
<li><p>MeasureSpec.UNSPECIFIED:父容器不对View有任何的影响，要多大就给多大</p>
</li>
<li><p>MeasureSpec.EXACTLY:父容器检测出View所需要的精确大小，这是View的最终大小就是specSize的值，其对应了match_parent模式</p>
</li>
<li><p>MeasureSpec.AT_MOST:父容器制定了可用大小，即specSize，View的大小不能大于这个值，对应wrap_content模式</p>
</li>
</ul>
<p>上述三种模式的说明来自于《android艺术开发探索》。在View的测量中，我们可以看到View的大小的测量跟设置的模式以及父布局是息息相关的，因此我们在进行自定义View的时候需要考虑到这两方面的因素。<br>我们重新回溯到setMeasuredDimension()方法中：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">setMeasuredDimension</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="keyword">boolean</span> optical = isLayoutModeOptical(<span class="keyword">this</span>);</div><div class="line">       <span class="keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line">           Insets insets = getOpticalInsets();</div><div class="line">           <span class="keyword">int</span> opticalWidth = insets.left + insets.right;</div><div class="line">           <span class="keyword">int</span> opticalHeight = insets.top + insets.bottom;</div><div class="line">​</div><div class="line">           measuredWidth += optical ? opticalWidth : -opticalWidth;</div><div class="line">           measuredHeight += optical ? opticalHeight : -opticalHeight;</div><div class="line">       &#125;</div><div class="line">       setMeasuredDimensionRaw(measuredWidth, measuredHeight);</div><div class="line">   &#125;</div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">setMeasuredDimensionRaw</span><span class="params">(<span class="keyword">int</span> measuredWidth, <span class="keyword">int</span> measuredHeight)</span> </span>&#123;</div><div class="line">       mMeasuredWidth = measuredWidth;</div><div class="line">       mMeasuredHeight = measuredHeight;</div><div class="line">​</div><div class="line">       mPrivateFlags |= PFLAG_MEASURED_DIMENSION_SET;</div><div class="line">   &#125;</div></pre></td></tr></table></figure>
<p>在其中我们看到最终会将计算得到的宽高传给mMeasuredHeight和mMeasuredWidth。<br>接下来在看看onLayout方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"></div><div class="line">    * Called from layout when this view should</div><div class="line">    * assign a size and position to each of its children.</div><div class="line">    *</div><div class="line">    * Derived classes with children should override</div><div class="line">    * this method and call layout on each of</div><div class="line">    * their children.</div><div class="line">    * <span class="doctag">@param</span> changed This is a new size or position for this view</div><div class="line">    * <span class="doctag">@param</span> left Left position, relative to parent</div><div class="line">    * <span class="doctag">@param</span> top Top position, relative to parent</div><div class="line">    * <span class="doctag">@param</span> right Right position, relative to parent</div><div class="line">    * <span class="doctag">@param</span> bottom Bottom position, relative to parent</div><div class="line">    */</div><div class="line">  <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">  &#125;</div></pre></td></tr></table></figure></p>
<p>onLayout()是一个空实现的方法，从注释当中我们可以看到此方法更适用于ViewGroup，只有View是一个ViewGroup才需要考虑到layout的位置的问题。</p>
<p>往下走，onDraw():<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"></div><div class="line">     * Implement this to do your drawing.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> canvas the canvas on which the background will be drawn</div><div class="line">     */</div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onDraw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>同样是空实现，这里自定义View通过重写该方法来进行绘制的操作。</p>
<p>ViewRootIpml<br>分析完上面的三个方法，我们更多地是看到一些赋值和空实现的方法，那么到底View的怎么开始绘制的过程的呢？这时候涉及到ViewRootIpml这个类了，它是连接View和WindowManager的桥梁，具体的作用是什么呢，我们从构建开始说起，一步步往下学习，首先我们找到其初始化的地方：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//WindowManagerGlobal</span></div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">addView</span><span class="params">(View view, ViewGroup.LayoutParams params,</span></span></div><div class="line"></div><div class="line">           Display display, Window parentWindow) &#123;</div><div class="line">           ...</div><div class="line"></div><div class="line">​</div><div class="line"></div><div class="line">           ViewRootImpl root;</div><div class="line">           View panelParentView = <span class="keyword">null</span>;</div><div class="line"></div><div class="line">           ...</div><div class="line"></div><div class="line">​</div><div class="line"></div><div class="line">           root = <span class="keyword">new</span> ViewRootImpl(view.getContext(), display);</div><div class="line">​</div><div class="line">           view.setLayoutParams(wparams);</div><div class="line">​</div><div class="line">           mViews.add(view);</div><div class="line">           mRoots.add(root);</div><div class="line">           mParams.add(wparams);</div><div class="line"></div><div class="line">       &#125;</div><div class="line">  <span class="keyword">try</span> &#123;</div><div class="line"></div><div class="line">           root.setView(view, wparams, panelParentView);</div><div class="line">       &#125; <span class="keyword">catch</span> (RuntimeException e) &#123;</div><div class="line">           <span class="comment">// BadTokenException or InvalidDisplayException, clean up.</span></div><div class="line">           <span class="keyword">synchronized</span> (mLock) &#123;</div><div class="line">               <span class="keyword">final</span> <span class="keyword">int</span> index = findViewLocked(view, <span class="keyword">false</span>);</div><div class="line">               <span class="keyword">if</span> (index &gt;= <span class="number">0</span>) &#123;</div><div class="line">                   removeViewLocked(index, <span class="keyword">true</span>);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">           <span class="keyword">throw</span> e;</div><div class="line">       &#125;</div><div class="line"></div><div class="line">​</div><div class="line">       ...</div><div class="line"></div><div class="line">   &#125;</div><div class="line">​</div></pre></td></tr></table></figure></p>
<p>我们在WindowManager的实现类WindowManagerGlobal找到了其ViewRootImpl初始化的地方(关于WindowManager在以后会进行深入探讨，现在主要知道它是window窗口的管理类即可)，从addView()方法中我们推测其是将View添加到window的一个过程(addView这个方法在ActivityThread的handleResumeActivity()中实现)，然后又调用了ViewRootImpl的setView()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line"><span class="comment">//ViewRootImpl</span></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">setView</span><span class="params">(View view, WindowManager.LayoutParams attrs, View panelParentView)</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="keyword">synchronized</span> (<span class="keyword">this</span>) &#123;</div><div class="line">           <span class="keyword">if</span> (mView == <span class="keyword">null</span>) &#123;</div><div class="line"></div><div class="line">                 ...</div><div class="line"></div><div class="line">               requestLayout();</div><div class="line"></div><div class="line">              ...</div><div class="line"></div><div class="line">               &#125;</div><div class="line"></div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">  <span class="meta">@Override</span></div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">requestLayout</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (!mHandlingLayoutInLayoutRequest) &#123;</div><div class="line">           checkThread();</div><div class="line">           mLayoutRequested = <span class="keyword">true</span>;</div><div class="line">           scheduleTraversals();</div><div class="line"></div><div class="line">       &#125;</div><div class="line"></div><div class="line">   &#125;</div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">scheduleTraversals</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">           <span class="keyword">if</span> (!mTraversalScheduled) &#123;</div><div class="line"></div><div class="line">               mTraversalScheduled = <span class="keyword">true</span>;</div><div class="line">               mTraversalBarrier = mHandler.getLooper().getQueue().postSyncBarrier();</div><div class="line">               mChoreographer.postCallback(</div><div class="line">                       Choreographer.CALLBACK_TRAVERSAL, mTraversalRunnable, <span class="keyword">null</span>);</div><div class="line">               <span class="keyword">if</span> (!mUnbufferedInputDispatch) &#123;</div><div class="line">                   scheduleConsumeBatchedInput();</div><div class="line">               &#125;</div><div class="line">               notifyRendererOfFramePending();</div><div class="line">               pokeDrawLockIfNeeded();</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   <span class="keyword">final</span> <span class="class"><span class="keyword">class</span> <span class="title">TraversalRunnable</span> <span class="keyword">implements</span> <span class="title">Runnable</span> </span>&#123;</div><div class="line"></div><div class="line">           <span class="meta">@Override</span></div><div class="line">           <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">run</span><span class="params">()</span> </span>&#123;</div><div class="line">               doTraversal();</div><div class="line"></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">doTraversal</span><span class="params">()</span> </span>&#123;</div><div class="line">           <span class="keyword">if</span> (mTraversalScheduled) &#123;</div><div class="line">               mTraversalScheduled = <span class="keyword">false</span>;</div><div class="line">               mHandler.getLooper().getQueue().removeSyncBarrier(mTraversalBarrier);</div><div class="line">​</div><div class="line">               <span class="keyword">if</span> (mProfile) &#123;</div><div class="line">                   Debug.startMethodTracing(<span class="string">"ViewAncestor"</span>);</div><div class="line">               &#125;</div><div class="line">​</div><div class="line">               performTraversals();</div><div class="line"></div><div class="line">​</div><div class="line">               <span class="keyword">if</span> (mProfile) &#123;</div><div class="line">                   Debug.stopMethodTracing();</div><div class="line">                   mProfile = <span class="keyword">false</span>;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performTraversals</span><span class="params">()</span> </span>&#123;</div><div class="line"></div><div class="line">        ...</div><div class="line"></div><div class="line">        performMeasure()；</div><div class="line">       ...</div><div class="line">       performLayout();</div><div class="line"></div><div class="line">        ...</div><div class="line"></div><div class="line">        performDraw();</div><div class="line"></div><div class="line">     &#125;</div><div class="line"></div><div class="line">​</div></pre></td></tr></table></figure></p>
<p>在这里我们可以看到当第一次进来的时候会设置mView的值，在其中调用了requestLayout()进行布局，然后依次是scheduleTraversals()-&gt;doTraversal()-&gt;performTraversals()的过程，在performTraversals()方法中调用了performMeasure(),performLayout(),performDraw()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performMeasure</span><span class="params">(<span class="keyword">int</span> childWidthMeasureSpec, <span class="keyword">int</span> childHeightMeasureSpec)</span> </span>&#123;</div><div class="line"></div><div class="line">       Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"measure"</span>);</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           mView.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">  <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performLayout</span><span class="params">(WindowManager.LayoutParams lp, <span class="keyword">int</span> desiredWindowWidth,</span></span></div><div class="line">           <span class="keyword">int</span> desiredWindowHeight) &#123;</div><div class="line">         <span class="comment">//当前mView是由WindowsManagerGlobal.addView传递过来，在ViewRootImpl中</span></div><div class="line">         <span class="comment">//通过setView()获得到的。</span></div><div class="line">         <span class="keyword">final</span> View host = mView;</div><div class="line">         ...</div><div class="line">           host.layout(<span class="number">0</span>, <span class="number">0</span>, host.getMeasuredWidth(), host.getMeasuredHeight());</div><div class="line">   ...</div><div class="line">           </div><div class="line">        mInLayout = <span class="keyword">false</span>;</div><div class="line">   &#125;</div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">performDraw</span><span class="params">()</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> (mAttachInfo.mDisplayState == Display.STATE_OFF &amp;&amp; !mReportNextDraw) &#123;</div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">​</div><div class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> fullRedrawNeeded = mFullRedrawNeeded;</div><div class="line">       mFullRedrawNeeded = <span class="keyword">false</span>;</div><div class="line">​</div><div class="line">       mIsDrawing = <span class="keyword">true</span>;</div><div class="line">       Trace.traceBegin(Trace.TRACE_TAG_VIEW, <span class="string">"draw"</span>);</div><div class="line">       <span class="keyword">try</span> &#123;</div><div class="line">           draw(fullRedrawNeeded);</div><div class="line">       &#125; <span class="keyword">finally</span> &#123;</div><div class="line">           mIsDrawing = <span class="keyword">false</span>;</div><div class="line">           Trace.traceEnd(Trace.TRACE_TAG_VIEW);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               mWindowSession.finishDrawing(mWindow);</div><div class="line">           &#125; <span class="keyword">catch</span> (RemoteException e) &#123;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line"> <span class="function"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(<span class="keyword">boolean</span> fullRedrawNeeded)</span> </span>&#123;</div><div class="line"></div><div class="line">       </div><div class="line"></div><div class="line">       ....</div><div class="line"></div><div class="line">         <span class="keyword">if</span> (!drawSoftware(surface, mAttachInfo, xOffset, yOffset, scalingRequired, dirty)) &#123;</div><div class="line"></div><div class="line">           <span class="keyword">return</span>;</div><div class="line">         &#125;</div><div class="line"></div><div class="line">               </div><div class="line"></div><div class="line">       &#125;</div><div class="line"></div><div class="line">       <span class="keyword">if</span> (animating) &#123;</div><div class="line">           mFullRedrawNeeded = <span class="keyword">true</span>;</div><div class="line">           scheduleTraversals();</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">​</div><div class="line">   <span class="comment">/**</span></div><div class="line">     * <span class="doctag">@return</span> true if drawing was successful, false if an error occurred</div><div class="line">     */</div><div class="line">   <span class="function"><span class="keyword">private</span> <span class="keyword">boolean</span> <span class="title">drawSoftware</span><span class="params">(Surface surface, AttachInfo attachInfo, <span class="keyword">int</span> xoff, <span class="keyword">int</span> yoff,</span></span></div><div class="line">           <span class="keyword">boolean</span> scalingRequired, Rect dirty) &#123;</div><div class="line">​</div><div class="line">     </div><div class="line"></div><div class="line">       mView.draw(canvas);</div><div class="line"></div><div class="line">​</div><div class="line">         drawAccessibilityFocusedDrawableIfNeeded(canvas);</div><div class="line"></div><div class="line">           </div><div class="line"></div><div class="line">       <span class="keyword">return</span> <span class="keyword">true</span>;</div><div class="line">   &#125;</div><div class="line">​</div></pre></td></tr></table></figure></p>
<p>在上面我们最终可以看到，measure-&gt;layout-&gt;draw的过程最终回调到了View中的对应的是三个方法,所以我们重新回到View中研究一下这些方法,从measure()看起：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"></div><div class="line">     * &lt;p&gt;</div><div class="line">     * This is called to find out how big a view should be. The parent</div><div class="line">     * supplies constraint information in the width and height parameters.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     * &lt;p&gt;</div><div class="line">     * The actual measurement work of a view is performed in</div><div class="line">     * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125;, called by this method. Therefore, only</div><div class="line">     * &#123;<span class="doctag">@link</span> #onMeasure(int, int)&#125; can and must be overridden by subclasses.</div><div class="line">     * &lt;/p&gt;</div><div class="line">     *</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> widthMeasureSpec Horizontal space requirements as imposed by the</div><div class="line">     *       parent</div><div class="line">     * <span class="doctag">@param</span> heightMeasureSpec Vertical space requirements as imposed by the</div><div class="line">     *       parent</div><div class="line">     *</div><div class="line">     * <span class="doctag">@see</span> #onMeasure(int, int)</div><div class="line">     */</div><div class="line"></div><div class="line"><span class="function"><span class="keyword">public</span> <span class="keyword">final</span> <span class="keyword">void</span> <span class="title">measure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line"></div><div class="line">       <span class="keyword">boolean</span> optical = isLayoutModeOptical(<span class="keyword">this</span>);</div><div class="line"></div><div class="line">   <span class="comment">//是否采用视觉边界</span></div><div class="line"></div><div class="line">       <span class="keyword">if</span> (optical != isLayoutModeOptical(mParent)) &#123;</div><div class="line"></div><div class="line">           Insets insets = getOpticalInsets();</div><div class="line"></div><div class="line">           <span class="keyword">int</span> oWidth = insets.left + insets.right;</div><div class="line"></div><div class="line">           <span class="keyword">int</span> oHeight = insets.top + insets.bottom;</div><div class="line">           widthMeasureSpec = MeasureSpec.adjust(widthMeasureSpec, optical ? -oWidth : oWidth);</div><div class="line">           heightMeasureSpec = MeasureSpec.adjust(heightMeasureSpec, optical ? -oHeight : oHeight);</div><div class="line">       &#125;</div><div class="line"></div><div class="line">        ···</div><div class="line"></div><div class="line">       onMeasure(widthMeasureSpec, heightMeasureSpec);</div><div class="line"></div><div class="line">       ···     </div><div class="line"></div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>从注释中我们可以了解到，其实该方法是计算View树的宽高的最终方法，宽高由父布局和子布局共同决定，且该方法不允许子类进行相关操作，因为其是final的，子类想要设置宽高需要通过onMeasure()方法来进行。</p>
<p>接下来我们再看下layout()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"></div><div class="line">     * Assign a size and position to a view and all of its</div><div class="line"></div><div class="line">     * descendants</div><div class="line">     *</div><div class="line">     * &lt;p&gt;This is the second phase of the layout mechanism.</div><div class="line">     * (The first is measuring). In this phase, each parent calls</div><div class="line">     * layout on all of its children to position them.</div><div class="line">     * This is typically done using the child measurements</div><div class="line">     * that were stored in the measure pass().&lt;/p&gt;</div><div class="line">     *</div><div class="line">     * &lt;p&gt;Derived classes should not override this method.</div><div class="line">     * Derived classes with children should override</div><div class="line">     * onLayout. In that method, they should</div><div class="line">     * call layout on each of their children.&lt;/p&gt;</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> l Left position, relative to parent</div><div class="line">     * <span class="doctag">@param</span> t Top position, relative to parent</div><div class="line">     * <span class="doctag">@param</span> r Right position, relative to parent</div><div class="line">     * <span class="doctag">@param</span> b Bottom position, relative to parent</div><div class="line">     */</div><div class="line">   <span class="meta">@SuppressWarnings</span>(&#123;<span class="string">"unchecked"</span>&#125;)</div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">layout</span><span class="params">(<span class="keyword">int</span> l, <span class="keyword">int</span> t, <span class="keyword">int</span> r, <span class="keyword">int</span> b)</span> </span>&#123;</div><div class="line">       <span class="keyword">if</span> ((mPrivateFlags3 &amp; PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT) != <span class="number">0</span>) &#123;</div><div class="line">           onMeasure(mOldWidthMeasureSpec, mOldHeightMeasureSpec);</div><div class="line">           mPrivateFlags3 &amp;= ~PFLAG3_MEASURE_NEEDED_BEFORE_LAYOUT;</div><div class="line">       &#125;</div><div class="line">​</div><div class="line">       <span class="keyword">int</span> oldL = mLeft;</div><div class="line">       <span class="keyword">int</span> oldT = mTop;</div><div class="line">       <span class="keyword">int</span> oldB = mBottom;</div><div class="line">       <span class="keyword">int</span> oldR = mRight;</div><div class="line">​</div><div class="line">       <span class="keyword">boolean</span> changed = isLayoutModeOptical(mParent) ?</div><div class="line">               setOpticalFrame(l, t, r, b) : setFrame(l, t, r, b);</div><div class="line"></div><div class="line">  <span class="comment">//setFrame会判断是否需要重新布局，即如果我们在完成一次View展示后，重新设置View的大小，那么</span></div><div class="line">      <span class="comment">//setFrame返回tru</span></div><div class="line"></div><div class="line">       <span class="keyword">if</span> (changed || (mPrivateFlags &amp; PFLAG_LAYOUT_REQUIRED) == PFLAG_LAYOUT_REQUIRED) &#123;</div><div class="line">           onLayout(changed, l, t, r, b);</div><div class="line"></div><div class="line">           mPrivateFlags &amp;= ~PFLAG_LAYOUT_REQUIRED;</div><div class="line">​</div><div class="line">           ListenerInfo li = mListenerInfo;</div><div class="line">           <span class="keyword">if</span> (li != <span class="keyword">null</span> &amp;&amp; li.mOnLayoutChangeListeners != <span class="keyword">null</span>) &#123;</div><div class="line">               ArrayList&lt;OnLayoutChangeListener&gt; listenersCopy =</div><div class="line">                       (ArrayList&lt;OnLayoutChangeListener&gt;)li.mOnLayoutChangeListeners.clone();</div><div class="line">               <span class="keyword">int</span> numListeners = listenersCopy.size();</div><div class="line">               <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; numListeners; ++i) &#123;</div><div class="line">                   listenersCopy.get(i).onLayoutChange(<span class="keyword">this</span>, l, t, r, b, oldL, oldT, oldR, oldB);</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">​</div><div class="line">       mPrivateFlags &amp;= ~PFLAG_FORCE_LAYOUT;</div><div class="line">       mPrivateFlags3 |= PFLAG3_IS_LAID_OUT;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>确认过大小后，我们需要定位View最终位置，在layout中会调用到onLayout()来获得我们需要展示的childrenView的效果。<br>draw()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/**</span></div><div class="line"></div><div class="line">     * Manually render this view (and all of its children) to the given Canvas.</div><div class="line">     * The view must have already done a full layout before this function is</div><div class="line">     * called. When implementing a view, implement</div><div class="line">     * &#123;<span class="doctag">@link</span> #onDraw(android.graphics.Canvas)&#125; instead of overriding this method.</div><div class="line">     * If you do need to override this method, call the superclass version.</div><div class="line">     *</div><div class="line">     * <span class="doctag">@param</span> canvas The Canvas to which the View is rendered.</div><div class="line">     */</div><div class="line">   <span class="meta">@CallSuper</span></div><div class="line">   <span class="function"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title">draw</span><span class="params">(Canvas canvas)</span> </span>&#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> privateFlags = mPrivateFlags;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> dirtyOpaque = (privateFlags &amp; PFLAG_DIRTY_MASK) == PFLAG_DIRTY_OPAQUE &amp;&amp;</div><div class="line">               (mAttachInfo == <span class="keyword">null</span> || !mAttachInfo.mIgnoreDirtyState);</div><div class="line">       mPrivateFlags = (privateFlags &amp; ~PFLAG_DIRTY_MASK) | PFLAG_DRAWN;</div><div class="line">​</div><div class="line">       <span class="comment">/*</span></div><div class="line">         * Draw traversal performs several drawing steps which must be executed</div><div class="line">         * in the appropriate order:</div><div class="line">         *</div><div class="line">         *     1. Draw the background</div><div class="line">         *     2. If necessary, save the canvas' layers to prepare for fading</div><div class="line"></div><div class="line">         *     3. Draw view's content</div><div class="line"></div><div class="line">         *     4. Draw children</div><div class="line">         *     5. If necessary, draw the fading edges and restore layers</div><div class="line">         *     6. Draw decorations (scrollbars for instance)</div><div class="line">         */</div><div class="line">​</div><div class="line">       <span class="comment">// Step 1, draw the background, if needed</span></div><div class="line">       <span class="keyword">int</span> saveCount;</div><div class="line">​</div><div class="line">       <span class="keyword">if</span> (!dirtyOpaque) &#123;</div><div class="line">           drawBackground(canvas);</div><div class="line">       &#125;</div><div class="line">​</div><div class="line">       <span class="comment">// skip step 2 &amp; 5 if possible (common case)</span></div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> viewFlags = mViewFlags;</div><div class="line">       <span class="keyword">boolean</span> horizontalEdges = (viewFlags &amp; FADING_EDGE_HORIZONTAL) != <span class="number">0</span>;</div><div class="line">       <span class="keyword">boolean</span> verticalEdges = (viewFlags &amp; FADING_EDGE_VERTICAL) != <span class="number">0</span>;</div><div class="line">       <span class="keyword">if</span> (!verticalEdges &amp;&amp; !horizontalEdges) &#123;</div><div class="line">           <span class="comment">// Step 3, draw the content</span></div><div class="line">           <span class="keyword">if</span> (!dirtyOpaque) onDraw(canvas);</div><div class="line">​</div><div class="line">           <span class="comment">// Step 4, draw the children</span></div><div class="line">          <span class="comment">//递归draw</span></div><div class="line"></div><div class="line">           dispatchDraw(canvas);</div><div class="line">​</div><div class="line">           <span class="comment">// Overlay is part of the content and draws beneath Foreground</span></div><div class="line">           <span class="keyword">if</span> (mOverlay != <span class="keyword">null</span> &amp;&amp; !mOverlay.isEmpty()) &#123;</div><div class="line">               mOverlay.getOverlayView().dispatchDraw(canvas);</div><div class="line">           &#125;</div><div class="line">​</div><div class="line">           <span class="comment">// Step 6, draw decorations (foreground, scrollbars)</span></div><div class="line">           onDrawForeground(canvas);</div><div class="line">​</div><div class="line">           <span class="comment">// we're done...</span></div><div class="line">           <span class="keyword">return</span>;</div><div class="line">       &#125;</div><div class="line">​</div></pre></td></tr></table></figure></p>
<p>看代码注释就可以很轻松知道draw中的步骤，这里就不详细解释了。</p>
<p>看到这里就对我们对View从哪里开始，并且如何一步步从测量绘制完成有了一个稍微深入的认识，画一个图先总结一下吧：</p>
<img src="/2016/12/09/android-View的探索-二-View的形成过程/one.png" alt="one" title="one">
<p>但是我们只看到了绘制完成的部分，并没有看到View是怎么展示在我们面前的，想要知道View如何被调用再到绘制完成显示出来，这就牵扯到atcivity的启动的过程了，这里不对这方面进行讲解，详细的过程可以大概看下：<br><a href="http://www.jianshu.com/p/93c66b3f08d6" target="_blank" rel="external">http://www.jianshu.com/p/93c66b3f08d6</a><br>我写的这篇文章(写的比较乱，有时间整理一下=￣ω￣=)，本身我们就知道activity启动完成显示到手机上会执行到onResume()这个方法，这个方法可硬对应在ActivityThread中的handleResumeActivity():<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div></pre></td><td class="code"><pre><div class="line">   <span class="function"><span class="keyword">final</span> <span class="keyword">void</span> <span class="title">handleResumeActivity</span><span class="params">(...)</span></span>&#123;</div><div class="line">          ....</div><div class="line">           <span class="keyword">else</span> <span class="keyword">if</span> (!willBeVisible) &#123;</div><div class="line">               <span class="keyword">if</span> (localLOGV) Slog.v(</div><div class="line">                   TAG, <span class="string">"Launch "</span> + r + <span class="string">" mStartedActivity set"</span>);</div><div class="line">               r.hideForNow = <span class="keyword">true</span>;</div><div class="line">           &#125;</div><div class="line">​</div><div class="line">           <span class="comment">// Get rid of anything left hanging around.</span></div><div class="line">           cleanUpPendingRemoveWindows(r);</div><div class="line">​</div><div class="line">           <span class="comment">// The window is now visible if it has been added, we are not</span></div><div class="line">           <span class="comment">// simply finishing, and we are not starting another activity.</span></div><div class="line">           <span class="keyword">if</span> (!r.activity.mFinished &amp;&amp; willBeVisible</div><div class="line">                   &amp;&amp; r.activity.mDecor != <span class="keyword">null</span> &amp;&amp; !r.hideForNow) &#123;</div><div class="line">               <span class="keyword">if</span> (r.newConfig != <span class="keyword">null</span>) &#123;</div><div class="line">                   r.tmpConfig.setTo(r.newConfig);</div><div class="line">                   <span class="keyword">if</span> (r.overrideConfig != <span class="keyword">null</span>) &#123;</div><div class="line">                       r.tmpConfig.updateFrom(r.overrideConfig);</div><div class="line">                   &#125;</div><div class="line">                   <span class="keyword">if</span> (DEBUG_CONFIGURATION) Slog.v(TAG, <span class="string">"Resuming activity "</span></div><div class="line">                           + r.activityInfo.name + <span class="string">" with newConfig "</span> + r.tmpConfig);</div><div class="line">                   performConfigurationChanged(r.activity, r.tmpConfig);</div><div class="line">                   freeTextLayoutCachesIfNeeded(r.activity.mCurrentConfig.diff(r.tmpConfig));</div><div class="line">                   r.newConfig = <span class="keyword">null</span>;</div><div class="line">               &#125;</div><div class="line">               <span class="keyword">if</span> (localLOGV) Slog.v(TAG, <span class="string">"Resuming "</span> + r + <span class="string">" with isForward="</span></div><div class="line">                       + isForward);</div><div class="line">               WindowManager.LayoutParams l = r.window.getAttributes();</div><div class="line">               <span class="keyword">if</span> ((l.softInputMode</div><div class="line">                       &amp; WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION)</div><div class="line">                       != forwardBit) &#123;</div><div class="line">                   l.softInputMode = (l.softInputMode</div><div class="line">                           &amp; (~WindowManager.LayoutParams.SOFT_INPUT_IS_FORWARD_NAVIGATION))</div><div class="line">                           | forwardBit;</div><div class="line">                   <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</div><div class="line">                       ViewManager wm = a.getWindowManager();</div><div class="line">                       View decor = r.window.getDecorView();</div><div class="line">                       wm.updateViewLayout(decor, l);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">               r.activity.mVisibleFromServer = <span class="keyword">true</span>;</div><div class="line">               mNumVisibleActivities++;</div><div class="line">               <span class="keyword">if</span> (r.activity.mVisibleFromClient) &#123;</div><div class="line">                   r.activity.makeVisible();</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">​</div><div class="line">           <span class="keyword">if</span> (!r.onlyLocalRequest) &#123;</div><div class="line">               r.nextIdle = mNewActivities;</div><div class="line">               mNewActivities = r;</div><div class="line">               <span class="keyword">if</span> (localLOGV) Slog.v(</div><div class="line">                   TAG, <span class="string">"Scheduling idle handler for "</span> + r);</div><div class="line">               Looper.myQueue().addIdleHandler(<span class="keyword">new</span> Idler());</div><div class="line">           &#125;</div><div class="line">           r.onlyLocalRequest = <span class="keyword">false</span>;</div><div class="line">​</div><div class="line">           <span class="comment">// Tell the activity manager we have resumed.</span></div><div class="line">           <span class="keyword">if</span> (reallyResume) &#123;</div><div class="line">               <span class="keyword">try</span> &#123;</div><div class="line">                   ActivityManagerNative.getDefault().activityResumed(token);</div><div class="line">               &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">​</div><div class="line">       &#125; <span class="keyword">else</span> &#123;</div><div class="line">           <span class="comment">// If an exception was thrown when trying to resume, then</span></div><div class="line">           <span class="comment">// just end this activity.</span></div><div class="line">           <span class="keyword">try</span> &#123;</div><div class="line">               ActivityManagerNative.getDefault()</div><div class="line">                   .finishActivity(token, Activity.RESULT_CANCELED, <span class="keyword">null</span>, <span class="keyword">false</span>);</div><div class="line">           &#125; <span class="keyword">catch</span> (RemoteException ex) &#123;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>代码中有句 r.activity.makeVisible()就是展示的关键的代码，他会让DecorView变为Visibile状态，最终展示出来。</p>
<hr>
<p>####ViewGrop<br>上面通过一系列的讲解只是从最简单的角度上而言——当页面中只有一个View的时候，但是绝大部分情况下是不可能的，往往项目中VIew树的层级是很深的(<strong>这里建议使用RelativeLayout作为初始布局容器</strong>)，那就涉及到ViewGroup了，其实ViewGroup也很简单，只不过多了一些递归的过程而已。</p>
<p>这里选择FrameLayout来进行大概的讲述吧(因为好多文章用了LinearLayout，RelativeLayout我又嫌麻烦。。)，从onMeasure()开始看：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div></pre></td><td class="code"><pre><div class="line">  <span class="meta">@Override</span></div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onMeasure</span><span class="params">(<span class="keyword">int</span> widthMeasureSpec, <span class="keyword">int</span> heightMeasureSpec)</span> </span>&#123;</div><div class="line">      <span class="comment">//获取子View的数量</span></div><div class="line"></div><div class="line">       <span class="keyword">int</span> count = getChildCount();</div><div class="line">  </div><div class="line">      <span class="comment">//当前布局宽高否是match_parent</span></div><div class="line">       <span class="keyword">final</span> <span class="keyword">boolean</span> measureMatchParentChildren =</div><div class="line">               MeasureSpec.getMode(widthMeasureSpec) != MeasureSpec.EXACTLY ||</div><div class="line">               MeasureSpec.getMode(heightMeasureSpec) != MeasureSpec.EXACTLY;</div><div class="line">       mMatchParentChildren.clear();</div><div class="line">​</div><div class="line">       <span class="keyword">int</span> maxHeight = <span class="number">0</span>;</div><div class="line">       <span class="keyword">int</span> maxWidth = <span class="number">0</span>;</div><div class="line">       <span class="keyword">int</span> childState = <span class="number">0</span>;</div><div class="line">​</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">           <span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">          <span class="comment">//GONE的布局不会进行测量</span></div><div class="line"></div><div class="line">           <span class="keyword">if</span> (mMeasureAllChildren || child.getVisibility() != GONE) &#123;</div><div class="line">              <span class="comment">//测量时加上margin参数</span></div><div class="line"></div><div class="line">               measureChildWithMargins(child, widthMeasureSpec, <span class="number">0</span>, heightMeasureSpec, <span class="number">0</span>);</div><div class="line">               <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">               maxWidth = Math.max(maxWidth,</div><div class="line">                       child.getMeasuredWidth() + lp.leftMargin + lp.rightMargin);</div><div class="line">               maxHeight = Math.max(maxHeight,</div><div class="line">                       child.getMeasuredHeight() + lp.topMargin + lp.bottomMargin);</div><div class="line">               childState = combineMeasuredStates(childState, child.getMeasuredState());</div><div class="line">               <span class="keyword">if</span> (measureMatchParentChildren) &#123;</div><div class="line">                   <span class="comment">//子布局中是否由含match_parent的布局，有则添加到mMatchParentChildren中</span></div><div class="line">                   <span class="keyword">if</span> (lp.width == LayoutParams.MATCH_PARENT ||</div><div class="line">                           lp.height == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">                       mMatchParentChildren.add(child);</div><div class="line">                   &#125;</div><div class="line">               &#125;</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">​</div><div class="line">       <span class="comment">// Account for padding too</span></div><div class="line">       maxWidth += getPaddingLeftWithForeground() + getPaddingRightWithForeground();</div><div class="line">       maxHeight += getPaddingTopWithForeground() + getPaddingBottomWithForeground();</div><div class="line">​</div><div class="line">       <span class="comment">// Check against our minimum height and width</span></div><div class="line">       maxHeight = Math.max(maxHeight, getSuggestedMinimumHeight());</div><div class="line">       maxWidth = Math.max(maxWidth, getSuggestedMinimumWidth());</div><div class="line">​</div><div class="line">       <span class="comment">// Check against our foreground's minimum height and width</span></div><div class="line">      <span class="comment">//计算图片宽度，取图片宽高和最大宽高两者之间最大值</span></div><div class="line"></div><div class="line">       <span class="keyword">final</span> Drawable drawable = getForeground();</div><div class="line">       <span class="keyword">if</span> (drawable != <span class="keyword">null</span>) &#123;</div><div class="line">           maxHeight = Math.max(maxHeight, drawable.getMinimumHeight());</div><div class="line">           maxWidth = Math.max(maxWidth, drawable.getMinimumWidth());</div><div class="line">       &#125;</div><div class="line">​</div><div class="line">       setMeasuredDimension(resolveSizeAndState(maxWidth, widthMeasureSpec, childState),</div><div class="line">               resolveSizeAndState(maxHeight, heightMeasureSpec,</div><div class="line">                       childState &lt;&lt; MEASURED_HEIGHT_STATE_SHIFT));​</div><div class="line">       count = mMatchParentChildren.size();</div><div class="line"></div><div class="line">      <span class="comment">//这里对于子布局是match_parent的进行重新测量得到准确值</span></div><div class="line">       <span class="keyword">if</span> (count &gt; <span class="number">1</span>) &#123;</div><div class="line">           <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">               <span class="keyword">final</span> View child = mMatchParentChildren.get(i);</div><div class="line">               <span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</div><div class="line">​</div><div class="line">               <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec;</div><div class="line">               <span class="keyword">if</span> (lp.width == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">                   <span class="keyword">final</span> <span class="keyword">int</span> width = Math.max(<span class="number">0</span>, getMeasuredWidth()</div><div class="line">                           - getPaddingLeftWithForeground() - getPaddingRightWithForeground()</div><div class="line">                           - lp.leftMargin - lp.rightMargin);</div><div class="line">                   childWidthMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                           width, MeasureSpec.EXACTLY);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   childWidthMeasureSpec = getChildMeasureSpec(widthMeasureSpec,</div><div class="line">                           getPaddingLeftWithForeground() + getPaddingRightWithForeground() +</div><div class="line">                           lp.leftMargin + lp.rightMargin,</div><div class="line">                           lp.width);</div><div class="line">               &#125;</div><div class="line">​</div><div class="line">               <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec;</div><div class="line">               <span class="keyword">if</span> (lp.height == LayoutParams.MATCH_PARENT) &#123;</div><div class="line">                   <span class="keyword">final</span> <span class="keyword">int</span> height = Math.max(<span class="number">0</span>, getMeasuredHeight()</div><div class="line">                           - getPaddingTopWithForeground() - getPaddingBottomWithForeground()</div><div class="line">                           - lp.topMargin - lp.bottomMargin);</div><div class="line">                   childHeightMeasureSpec = MeasureSpec.makeMeasureSpec(</div><div class="line">                           height, MeasureSpec.EXACTLY);</div><div class="line">               &#125; <span class="keyword">else</span> &#123;</div><div class="line">                   childHeightMeasureSpec = getChildMeasureSpec(heightMeasureSpec,</div><div class="line">                           getPaddingTopWithForeground() + getPaddingBottomWithForeground() +</div><div class="line">                           lp.topMargin + lp.bottomMargin,</div><div class="line">                           lp.height);</div><div class="line">               &#125;</div><div class="line">                <span class="comment">//调用子布局的measure()方法</span></div><div class="line">               child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line"></div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">​</div><div class="line"><span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">measureChildWithMargins</span><span class="params">(View child,</span></span></div><div class="line">           <span class="keyword">int</span> parentWidthMeasureSpec, <span class="keyword">int</span> widthUsed,</div><div class="line">           <span class="keyword">int</span> parentHeightMeasureSpec, <span class="keyword">int</span> heightUsed) &#123;</div><div class="line">       <span class="keyword">final</span> MarginLayoutParams lp = (MarginLayoutParams) child.getLayoutParams();</div><div class="line">​</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> childWidthMeasureSpec = getChildMeasureSpec(parentWidthMeasureSpec,</div><div class="line">               mPaddingLeft + mPaddingRight + lp.leftMargin + lp.rightMargin</div><div class="line">                       + widthUsed, lp.width);</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> childHeightMeasureSpec = getChildMeasureSpec(parentHeightMeasureSpec,</div><div class="line">               mPaddingTop + mPaddingBottom + lp.topMargin + lp.bottomMargin</div><div class="line">                       + heightUsed, lp.height);</div><div class="line">​            <span class="comment">//调用子布局的measure()方法</span></div><div class="line">       child.measure(childWidthMeasureSpec, childHeightMeasureSpec);</div><div class="line">   &#125;</div></pre></td></tr></table></figure></p>
<p>从onMeasure()可以看到主要的方法就是child.measure()的调用，他会调用到View的measure()，measure()又会重新调用onMeasure()由此形成依次递归直到获取到正确的测量结果。</p>
<p>onLayout()方法：<br><figure class="highlight java"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div></pre></td><td class="code"><pre><div class="line">   <span class="meta">@Override</span></div><div class="line"></div><div class="line">   <span class="function"><span class="keyword">protected</span> <span class="keyword">void</span> <span class="title">onLayout</span><span class="params">(<span class="keyword">boolean</span> changed, <span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom)</span> </span>&#123;</div><div class="line">       layoutChildren(left, top, right, bottom, <span class="keyword">false</span> <span class="comment">/* no force left gravity */</span>);</div><div class="line">   &#125;</div><div class="line">​</div><div class="line">   <span class="function"><span class="keyword">void</span> <span class="title">layoutChildren</span><span class="params">(<span class="keyword">int</span> left, <span class="keyword">int</span> top, <span class="keyword">int</span> right, <span class="keyword">int</span> bottom,</span></span></div><div class="line">                                 <span class="keyword">boolean</span> forceLeftGravity) &#123;</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> count = getChildCount();</div><div class="line">​</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> parentLeft = getPaddingLeftWithForeground();</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> parentRight = right - left - getPaddingRightWithForeground();</div><div class="line">​</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> parentTop = getPaddingTopWithForeground();</div><div class="line">       <span class="keyword">final</span> <span class="keyword">int</span> parentBottom = bottom - top - getPaddingBottomWithForeground();</div><div class="line">​</div><div class="line">       <span class="keyword">for</span> (<span class="keyword">int</span> i = <span class="number">0</span>; i &lt; count; i++) &#123;</div><div class="line">           <span class="keyword">final</span> View child = getChildAt(i);</div><div class="line">           <span class="keyword">if</span> (child.getVisibility() != GONE) &#123;</div><div class="line">               <span class="keyword">final</span> LayoutParams lp = (LayoutParams) child.getLayoutParams();</div><div class="line">​</div><div class="line">               <span class="keyword">final</span> <span class="keyword">int</span> width = child.getMeasuredWidth();</div><div class="line">               <span class="keyword">final</span> <span class="keyword">int</span> height = child.getMeasuredHeight();</div><div class="line">​</div><div class="line">               <span class="keyword">int</span> childLeft;</div><div class="line">               <span class="keyword">int</span> childTop;</div><div class="line">​</div><div class="line">               <span class="keyword">int</span> gravity = lp.gravity;</div><div class="line">               <span class="keyword">if</span> (gravity == -<span class="number">1</span>) &#123;</div><div class="line">                   gravity = DEFAULT_CHILD_GRAVITY;</div><div class="line">               &#125;</div><div class="line">​</div><div class="line">               <span class="keyword">final</span> <span class="keyword">int</span> layoutDirection = getLayoutDirection();</div><div class="line">               <span class="keyword">final</span> <span class="keyword">int</span> absoluteGravity = Gravity.getAbsoluteGravity(gravity, layoutDirection);</div><div class="line">               <span class="keyword">final</span> <span class="keyword">int</span> verticalGravity = gravity &amp; Gravity.VERTICAL_GRAVITY_MASK;</div><div class="line">​</div><div class="line">               <span class="keyword">switch</span> (absoluteGravity &amp; Gravity.HORIZONTAL_GRAVITY_MASK) &#123;</div><div class="line">                   <span class="keyword">case</span> Gravity.CENTER_HORIZONTAL:</div><div class="line">                       childLeft = parentLeft + (parentRight - parentLeft - width) / <span class="number">2</span> +</div><div class="line">                       lp.leftMargin - lp.rightMargin;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   <span class="keyword">case</span> Gravity.RIGHT:</div><div class="line">                       <span class="keyword">if</span> (!forceLeftGravity) &#123;</div><div class="line">                           childLeft = parentRight - width - lp.rightMargin;</div><div class="line">                           <span class="keyword">break</span>;</div><div class="line">                       &#125;</div><div class="line">                   <span class="keyword">case</span> Gravity.LEFT:</div><div class="line">                   <span class="keyword">default</span>:</div><div class="line">                       childLeft = parentLeft + lp.leftMargin;</div><div class="line">               &#125;</div><div class="line">​</div><div class="line">               <span class="keyword">switch</span> (verticalGravity) &#123;</div><div class="line">                   <span class="keyword">case</span> Gravity.TOP:</div><div class="line">                       childTop = parentTop + lp.topMargin;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   <span class="keyword">case</span> Gravity.CENTER_VERTICAL:</div><div class="line">                       childTop = parentTop + (parentBottom - parentTop - height) / <span class="number">2</span> +</div><div class="line">                       lp.topMargin - lp.bottomMargin;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   <span class="keyword">case</span> Gravity.BOTTOM:</div><div class="line">                       childTop = parentBottom - height - lp.bottomMargin;</div><div class="line">                       <span class="keyword">break</span>;</div><div class="line">                   <span class="keyword">default</span>:</div><div class="line">                       childTop = parentTop + lp.topMargin;</div><div class="line">               &#125;</div><div class="line">​              <span class="comment">//调用子View的layout</span></div><div class="line">               child.layout(childLeft, childTop, childLeft + width, childTop + height);</div><div class="line">           &#125;</div><div class="line">       &#125;</div><div class="line">   &#125;</div><div class="line">​</div></pre></td></tr></table></figure></p>
<p>可以看到layout也是一个递归调用的过程，这里就不详细讲述了，而由于ViewGroup没有onDraw()方法，这里就不需要讲了。</p>
<p>附上一张View的生命周期:<br><img src="/2016/12/09/android-View的探索-二-View的形成过程/two.jpg" alt="cyclelife" title="cyclelife"></p>
<hr>
<p>终于写完了，脑袋都要爆炸了，View形成的过程大概就是这样的，谢谢阅读，如果觉得哪写的不对或者不好的地方欢迎留言交流，希望能够一起进步~</p>

      
    </div>

    <div>
      
        

      
    </div>

    <div>
      
        

      
    </div>


    <footer class="post-footer">
      
        <div class="post-tags">
          
            <a href="/tags/android/" rel="tag"># android</a>
          
        </div>
      

      
        <div class="post-nav">
          <div class="post-nav-next post-nav-item">
            
              <a href="/2016/12/09/android-View的探索-一-setContentView-过程研究/" rel="next" title="android View的探索(一) : setContentView()过程研究">
                <i class="fa fa-chevron-left"></i> android View的探索(一) : setContentView()过程研究
              </a>
            
          </div>

          <span class="post-nav-divider"></span>

          <div class="post-nav-prev post-nav-item">
            
              <a href="/2016/12/12/Picasso源码分析/" rel="prev" title="Picasso源码分析">
                Picasso源码分析 <i class="fa fa-chevron-right"></i>
              </a>
            
          </div>
        </div>
      

      
      
    </footer>
  </article>



    <div class="post-spread">
      
    </div>
  </div>


          </div>
          


          
  <div class="comments" id="comments">
    
      <div class="ds-thread" data-thread-key="2016/12/09/android-View的探索-二-View的形成过程/"
           data-title="android View的探索(二) : View的形成过程" data-url="http://yoursite.com/2016/12/09/android-View的探索-二-View的形成过程/">
      </div>
    
  </div>


        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.jpg"
               alt="Jerry Chan" />
          <p class="site-author-name" itemprop="name">Jerry Chan</p>
          <p class="site-description motion-element" itemprop="description">In me the tiger sniffes the rose</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">10</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">4</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">2</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/JerryChan123" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://weibo.com/Jerry_Linnnnnnn" target="_blank" title="微博">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  微博
                </a>
              </span>
            
              <span class="links-of-author-item">
                <a href="http://www.zhihu.com/people/annylin0922" target="_blank" title="知乎">
                  
                    <i class="fa fa-fw fa-globe"></i>
                  
                  知乎
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Jerry Chan</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>


        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.1.0"></script>



  
  <script type="text/javascript" src="/js/src/scrollspy.js?v=5.1.0"></script>
<script type="text/javascript" src="/js/src/post-details.js?v=5.1.0"></script>



  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"jerrychan123"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    
    <script src="/lib/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  








  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("OtRTTkhYQKMh2ztC9L6czjbP-gzGzoHsz", "dsKHW7hE1MX9u21g5zouUp7R");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  

  


</body>
</html>
